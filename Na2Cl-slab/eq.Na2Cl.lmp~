# ==========================================================================
# ==========================================================================
# Equilibrate NaCl in TIP4P Water Slab
# Written by: Amro Dodin (Geissler Group - UC Berkeley & LBL)
#
# Required Variable Inputs:
#      - BIAS: 0 if Unbiased. 1 if Running PLUMED Biasing
#           - BIASFILE (if BIAS=1): plumed file with bias info
#
# Optional Variables:
#		- SEED: Random SEED
#		- DATADIR: Location to Save Output Data
#
# Optional Environment Variables:
#		- DATAROOT: Default location where Data is stored
#	    - FFDIR: Default location where FF params are stored
# ==========================================================================
# ==========================================================================

# ==========================================================================
# Set Simulation Parameters
# ==========================================================================

include parameters.lmp

# ==========================================================================
# Simulation Set Up
# ==========================================================================

# Atom & FF Style Specification
pair_style lj/cut/coul/long 10
atom_style full
bond_style harmonic
angle_style harmonic
improper_style harmonic
kspace_style pppm 1.0e-3
neighbor 2.0 bin   # Includes atoms r <= lj_cut + 2.0 in neighborlist

# Read Input Data (from min.swm4-ndp-slab.lmp)
read_data ${DATADIR}${INPREFIX}data.${label}.min

# ==========================================================================
# Force Field Parametrization
# ==========================================================================

# Symmetric SWM4-NDP Coefficients
include ${FFDIR}ff.tip4p-NaCl.lmp

# ==========================================================================
# Create Atom Groups
# ==========================================================================

group WATERS type 1 2 3
group OXYGENS type 1
group HYDROGENS type 2
group IONS type 4 5
group Cl type 4
group Na type 5
group PLUMEDOUT id 2301 2302 2303

# ==========================================================================
# Initialize Simulation
# ==========================================================================

# Set Time Step
timestep ${dt}

# Delete Bonded Interactions covered by rigid dynamics
delete_bonds all multi

# ==========================================================================
# Output Computes
# ==========================================================================
# Temperature Computes
variable THeat equal ramp(1,v_TK)

# Atom Dump
dump at all custom ${atomFreq} ${DATADIR}eq.${label}.lammpstrj &
    id mol type x y z vx vy vz fx fy fz

# xyz file of Bias-relevant DOFS
dump CV PLUMEDOUT xyz ${cvFreq} ${DATADIR}eq.CV.${label}.xyz

# Thermodynamic Output
thermo_style custom time econserve etotal pe temp v_THeat fmax
thermo ${thermoFreq}

# ==========================================================================
# Integration Fixes & Computes (Heating)
# ==========================================================================

# Dual Langevin Integrator w/ramp
if "${BIAS}!=0" then &
    "fix bias all plumed plumedfile ${BIASFILE} outfile ${DATADIR}p.log"
fix LANG all langevin 1 ${TK} ${gammat} $S
fix NVE WATERS rigid/nve/small molecule
fix IONSNVE IONS nve

# ==========================================================================
# Heating Run
# ==========================================================================

run ${nHeat}

# ==========================================================================
# Clean Up Heating Run
# ==========================================================================

# Delete Variables
variable THeat equal ${TK}

# Remove Integration fixes
unfix LANG
unfix NVE
unfix IONSNVE

# ==========================================================================
# Integration Fixes (Equilibration)
# ==========================================================================

# Dual Nose-Hoover Integrator
fix LANG all langevin ${TK} ${TK} ${gammat} $S
fix NVE WATERS rigid/nve/small molecule
fix IONSNVE IONS nve

# Water Analysis Output
variable nStep equal v_nEquil
#include water-analysis.lmp

# ==========================================================================
# Equilibration Run
# ==========================================================================

run ${nEquil}

# ==========================================================================
# Save Equilibrated Configurations
# ==========================================================================

write_data ${DATADIR}data.${label}.eq
